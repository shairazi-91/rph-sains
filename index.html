<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-RPH Sains Tingkatan 2 - SMK Datuk Patinggi Kedit</title>
    
    <!-- Tailwind CSS (Untuk Design Cantik) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Font Cantik -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

        /* --- LOADING OVERLAY (Cantik & Professional) --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            visibility: hidden; opacity: 0; transition: opacity 0.3s ease;
        }
        #loading-overlay.active { visibility: visible; opacity: 1; }

        /* --- PDF PREVIEW (Disembunyikan untuk User, Muncul masa Print) --- */
        #pdf-preview-section {
            display: none; background: white; width: 210mm; min-height: 297mm;
            margin: 0 auto; padding: 15mm; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        /* Mod Generasi PDF (Tukar Paparan) */
        body.generating-mode #main-ui, body.generating-mode nav { display: none; }
        body.generating-mode #pdf-preview-section { display: block; }
        body.generating-mode { background-color: white; }

        /* --- TABLE STYLE (Untuk PDF) --- */
        .official-table {
            width: 100%; border-collapse: collapse; border: 1px solid #000;
            font-family: 'Times New Roman', Times, serif; font-size: 11pt; color: #000;
        }
        .official-table td {
            border: 1px solid #000; padding: 6px 8px; vertical-align: top; line-height: 1.3;
        }
        .bg-gray-official { background-color: #e5e7eb; font-weight: bold; width: 20%; }
        
        .text-content { white-space: pre-wrap; text-align: justify; }
        
        /* Garisan Refleksi */
        .refleksi-line { border-bottom: 1px dotted #000; height: 28px; margin-top: 5px; }

        /* --- BUTTON STYLE --- */
        .ai-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            padding: 6px 14px; border-radius: 9999px; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
        }
        .ai-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(79, 70, 229, 0.4); }
        .ai-btn:active { transform: translateY(0); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="relative">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
            <div class="absolute top-0 left-0 h-16 w-16 flex items-center justify-center">
                <div class="h-8 w-8 bg-blue-100 rounded-full opacity-50 animate-pulse"></div>
            </div>
        </div>
        <h2 id="loading-text" class="text-lg font-bold text-gray-700 mt-4 tracking-wide">MEMPROSES...</h2>
        <p class="text-sm text-gray-500 mt-1">Sila tunggu sebentar.</p>
    </div>

    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="https://i.postimg.cc/15tfw5q1/logo-kedit.avif" alt="Logo" class="h-12 w-auto bg-white rounded-full p-0.5 shadow-sm">
                <div>
                    <h1 class="text-lg font-bold leading-tight uppercase tracking-wide">e-RPH Sains T2</h1>
                    <p class="text-xs text-blue-200 uppercase tracking-wider">SMK Datuk Patinggi Kedit</p>
                </div>
            </div>
            <span class="text-xs bg-white/10 backdrop-blur-md border border-white/20 px-3 py-1 rounded-full hidden sm:inline-block font-medium">DSKP KSSM + AI</span>
        </div>
    </nav>

    <!-- Main UI -->
    <main id="main-ui" class="max-w-4xl mx-auto px-4 py-8 pb-24">
        
        <!-- API KEY Box -->
        <div class="bg-white p-5 rounded-xl border border-blue-100 shadow-sm mb-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-blue-600"></div>
            <label class="block text-xs font-bold text-blue-800 mb-2 uppercase tracking-wide">Tetapan AI (Google Gemini)</label>
            <div class="flex gap-3">
                <input type="password" id="apiKey" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Tampal API Key anda di sini...">
                <button onclick="saveKey()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-xs font-bold transition shadow-sm">SIMPAN</button>
            </div>
            <p class="text-[10px] text-gray-400 mt-2">*API Key disimpan dalam pelayar anda sahaja. Gunakan akaun Gmail peribadi.</p>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center">
                <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <h2 class="text-lg font-bold text-gray-700">Butiran Pengajaran</h2>
            </div>

            <div class="p-6 space-y-6">
                <!-- Grid Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Mata Pelajaran</label>
                        <input type="text" id="inp_subject" value="Sains" class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600 font-medium" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Kelas</label>
                        <input type="text" id="inp_kelas" placeholder="Contoh: 2 Bestari" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Tarikh</label>
                        <input type="date" id="inp_tarikh" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Masa</label>
                        <input type="text" id="inp_masa" placeholder="8.00 - 9.00 Pagi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- Dropdown DSKP -->
                <div class="bg-indigo-50/50 p-5 rounded-xl border border-indigo-100 space-y-4">
                    <h3 class="font-bold text-indigo-900 text-sm uppercase flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        Pilihan DSKP
                    </h3>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">1. Bab / Topik</label>
                        <select id="sel_bab" onchange="updateSK()" class="w-full px-4 py-2 border border-indigo-200 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="">-- Sila Pilih Bab --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">2. Standard Kandungan (SK)</label>
                        <select id="sel_sk" onchange="updateSP()" class="w-full px-4 py-2 border border-indigo-200 rounded-lg bg-white disabled:bg-gray-100 disabled:text-gray-400" disabled>
                            <option value="">-- Pilih Bab Dahulu --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">3. Standard Pembelajaran (SP)</label>
                        <select id="sel_sp" onchange="addSP()" class="w-full px-4 py-2 border border-indigo-200 rounded-lg bg-white disabled:bg-gray-100 disabled:text-gray-400" disabled>
                            <option value="">-- Pilih SP (Boleh pilih banyak kali) --</option>
                        </select>
                    </div>
                </div>

                <!-- Paparan SK/SP -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Standard Kandungan</label>
                        <textarea id="txt_sk" rows="3" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600" readonly></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Standard Pembelajaran</label>
                        <textarea id="txt_sp" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm shadow-inner" placeholder="Item yang dipilih akan muncul di sini..."></textarea>
                    </div>
                </div>

                <!-- AI Objektif -->
                <div class="relative group">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-semibold text-gray-700">Objektif Pembelajaran</label>
                        <button type="button" onclick="runAI('obj')" class="ai-btn">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Jana AI
                        </button>
                    </div>
                    <textarea id="txt_obj" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-sm" placeholder="Taip manual atau guna AI..."></textarea>
                </div>

                <!-- AI Aktiviti -->
                <div class="relative group">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-semibold text-gray-700">Aktiviti PdPc (Model 5E)</label>
                        <button type="button" onclick="runAI('akt')" class="ai-btn">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Jana AI
                        </button>
                    </div>
                    <textarea id="txt_akt" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-sm" placeholder="Taip manual atau guna AI..."></textarea>
                </div>

                <!-- Pentaksiran -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pentaksiran / PBD</label>
                    <textarea id="txt_pbd" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition text-sm"></textarea>
                </div>

                <!-- Refleksi -->
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    <label class="block text-sm font-bold text-yellow-800 mb-1">Refleksi (Nota Peribadi)</label>
                    <p class="text-[10px] text-yellow-600 mb-2 uppercase tracking-wide font-bold">* Ruangan ini akan dikosongkan dalam PDF untuk tulisan tangan.</p>
                    <textarea id="txt_ref" rows="2" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 transition text-sm bg-white" placeholder="Nota untuk rujukan anda sahaja..."></textarea>
                </div>
            </div>

            <!-- Footer Button -->
            <div class="bg-gray-50 px-6 py-5 flex justify-end border-t border-gray-200">
                <button id="btnGenerate" onclick="prepareAndPrint()" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    JANA PDF
                </button>
            </div>
        </div>
        <p class="text-center text-gray-400 text-xs mt-8 font-medium tracking-wide">2026 created by Cikgu Shairazi</p>
    </main>

    <!-- PDF PREVIEW SECTION (HIDDEN) -->
    <div id="pdf-preview-section">
        <div class="flex items-center justify-center border-b-2 border-black pb-3 mb-4">
            <div style="width: 15%; display: flex; justify-content: center;">
                <img src="https://i.postimg.cc/15tfw5q1/logo-kedit.avif" alt="Logo" style="width: 75px; height: auto;" crossorigin="anonymous">
            </div>
            <div style="width: 85%; text-align: center;">
                <h1 class="text-xl font-bold uppercase tracking-wider" style="font-family: 'Times New Roman'; margin-bottom: 2px;">RANCANGAN PENGAJARAN HARIAN</h1>
                <h2 class="text-lg font-bold uppercase" style="font-family: 'Times New Roman';">SMK DATUK PATINGGI KEDIT</h2>
            </div>
        </div>

        <table class="official-table">
            <tr>
                <td class="bg-gray-official">Mata Pelajaran</td><td style="width: 35%;" id="out_subject"></td>
                <td class="bg-gray-official">Kelas</td><td style="width: 35%;" id="out_kelas"></td>
            </tr>
            <tr>
                <td class="bg-gray-official">Tarikh</td><td id="out_tarikh"></td>
                <td class="bg-gray-official">Masa</td><td id="out_masa"></td>
            </tr>
            <tr><td class="bg-gray-official" colspan="4">Bab / Topik</td></tr>
            <tr><td colspan="4" id="out_bab" style="font-weight: bold;"></td></tr>
            <tr><td class="bg-gray-official" colspan="4">Standard Kandungan</td></tr>
            <tr><td colspan="4" id="out_sk"></td></tr>
            <tr><td class="bg-gray-official" colspan="4">Standard Pembelajaran</td></tr>
            <tr><td colspan="4" id="out_sp" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4">Objektif Pembelajaran</td></tr>
            <tr><td colspan="4" id="out_obj" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4">Aktiviti PdPc</td></tr>
            <tr><td colspan="4" id="out_akt" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4">Pentaksiran / PBD</td></tr>
            <tr><td colspan="4" id="out_pbd" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4">Refleksi</td></tr>
            <tr>
                <td colspan="4" style="height: 100px; vertical-align: top; padding-top: 10px;">
                    <div class="refleksi-line"></div>
                    <div class="refleksi-line"></div>
                    <div class="refleksi-line"></div>
                </td>
            </tr>
        </table>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // DATA DSKP LENGKAP
        const dskpData = {
            "1.0 BIODIVERSITY": { "1.1 Diversity of organism": ["1.1.1 Elaborate and communicate about biodiversity.", "1.1.2 Justify the needs to manage biodiversity effectively."], "1.2 Classification of organisms": ["1.2.1 Differentiate organisms using a dichotomous key based on common characteristics.", "1.2.2 Characterise the major taxonomy group."] },
            "2.0 ECOSYSTEM": { "2.1 Energy flow in ecosystem": ["2.1.1 Explain with examples of producer, consumer and decomposer.", "2.1.2 Interprete food chain and food web."], "2.2 Nutrient cycle in the ecosystem": ["2.2.1 Elaborate and communicate about the role of living things in the oxygen and carbon cycles in the ecosystem.", "2.2.2 Justify the role of organisms in the water cycle of an ecosystem.", "2.2.3 Solve problems when there are interferences to the cycles caused by human activities."], "2.3 Interdependence and interaction among organisms": ["2.3.1 Explain with examples the interdependence among living things and the environment to maintain a balanced ecosystem.", "2.3.2 Justify the importance of adaptations of living things to the environment.", "2.3.3 Communicate examples of interactions between organisms and apply these interactions in daily life.", "2.3.4 Separate the factors that affect the size of population in an ecosystem.", "2.3.5 Predict how the changes in ecosystem affect the existing resources and balance of the population."], "2.4 The role of human in maintaining a balanced nature": ["2.4.1 Justify and communicate that man needs a stable and productive ecosystem to sustain life."] },
            "3.0 NUTRITION": { "3.1 Classes of food": ["3.1.1 Elaborate and communicate about classes of food.", "3.1.2 Test the presence of starch, glucose, protein and fats in food."], "3.2 Importance of a balanced diet": ["3.2.1 Elaborate and communicate about a balanced diet.", "3.2.2 Estimate calories of food intake in a meal and plan a balanced diet.", "3.2.3 Conduct a research and justify the importance of a balanced diet, exercise and a healthy lifestyle."], "3.3 Human's digestive system": ["3.3.1 Elaborate and communicate about digestion."], "3.4 Process of absorption and transportation of digested food and defecation": ["3.4.1 Conduct an experiment to explain the absorption of the end products of digestion.", "3.4.2 Relate the function of digestive system, blood circulatory system and respiratory system.", "3.4.3 Elaborate and communicate about defecation."] },
            "4.0 HUMAN HEALTH": { "4.1 Infectious and non-infectious diseases": ["4.1.1 Differentiate and communicate about infectious and non-infectious diseases.", "4.1.2 Explain how infectious diseases are spread.", "4.1.3 Separate the cause and spread of infectious diseases.", "4.1.4 Generate ideas on the mechanism to prevent the spread of infectious diseases."], "4.2 Body defence system": ["4.2.1 Elaborate and communicate about the function of body defence system.", "4.2.2 Define antigens,antibodies and immunity.", "4.2.3 Justify the importance of immunisation.", "4.2.4 Differentiate passive immunity and active immunity.", "4.2.5 Justify good practices towards attaining strong immune system.", "4.2.6 Justify and communicate about the importance of immunisation and health level."] },
            "5.0 WATER AND SOLUTION": { "5.1 Physical characteristics of water": ["5.1.1 Elaborate and communicate about water.", "5.1.2 Carry out experiments and communicate about the water evaporation process in daily life."], "5.2 Solution and rate of solubility": ["5.2.1 Explain with example the meaning of solution and solubility.", "5.2.2 Carry out experiment to determine the factors affecting the rate of solubility.", "5.2.3 Explain with examples the meaning of colloids in daily life.", "5.2.4 Elaborate and communicate the uses of water as a universal solvent.", "5.2.5 Demonstrate examples of organic solvent and their uses in daily life."], "5.3 Water purification and water supply": ["5.3.1 Demonstrate the water purification method.", "5.3.2 Solve problems in getting water supply for daily life usage.", "5.3.3 Build a model and communicate about water supply system.", "5.3.4 Justify water sustainability as a key to healthy living."] },
            "6.0 ACID AND ALKALI": { "6.1 Properties of acid and alkali": ["6.1.1 Defining operationally acid and alkali.", "6.1.2 Explain with examples of acidic and alkaline subtances.", "6.1.3 Demonstrate the technique to determine the strength of acid and alkali based on pH value.", "6.1.4 Identify the uses of acid and alkali in daily life."], "6.2 Neutralisation": ["6.2.1 Explain the neutralization reaction.", "6.2.2 Explain with examples the use of neutralisation reaction in daily life."] },
            "7.0 ELECTRICITY AND MAGNETISM": { "7.1 Electricity": ["7.1.1 Describe and communicate about energy.", "7.1.2 Explain and communicate about the existence of electrostatic charges.", "7.1.3 Explain with examples on electrostatic in daily life.", "7.1.4 Draw a conclusion that the flow of charges produce electric current.", "7.1.5 Characterise current, voltage and resistance and their units.", "7.1.6 Draw a conclusion on the relationship between current, voltage and resistance."], "7.2 The flow of electric current in series circuit and parallel circuit": ["7.2.1 Elaborate and communicate about the flow of electric current in series circuit and parallel circuit."], "7.3 Magnetism": ["7.3.1 Draw a conclusion about the characteristics of a magnet.", "7.3.2 Describe and communicate about electromagnet.", "7.3.3 Carry out an experiment and communicate about the uses of magnet and electromagnet in daily life."] },
            "8.0 FORCE AND MOTION": { "8.1 Force": ["8.1.1 Elaborate and communicate about force.", "8.1.2 Explain that force has magnitude, direction and point of application.", "8.1.3 Measure force in S.I. unit.", "8.1.4 Explain with examples that every action force has an equal reaction force."], "8.2 Effects of force": ["8.2.1 Elaborate and communicate about the effects of force.", "8.2.2 Explain and communicate the relationship between the differences in densities and the effects of bouyancy.", "8.2.3 Classify and solve problems on levers based on the position of fulcrum, load and effort.", "8.2.4 Explain and communicate about the moment of force.", "8.2.5 Carry out an experiment and communicate about pressure and its application in daily life.", "8.2.6 Elaborate and communicate about gas pressure based on the kinetic theory of gas.", "8.2.7 Explain and communicate about the existance of atmospheric pressure.", "8.2.8 Explain the effects of depth on liquid pressure."] },
            "9.0 HEAT": { "9.1 Temperature and heat": ["9.1.1 Make a comparison between heat and temperature."], "9.2 Heat flow and thermal equilibrium": ["9.2.1 Explain how heat flows from a hot region to a cold region.", "9.2.2 Explain and communicate about heat flow in natural phenomena.", "9.2.3 Communicate about heat conductors and heat insulators and their uses in daily life."], "9.3 Principle of expansion and contraction of matter": ["9.3.1 Explain how heat can cause the expansion and contraction in solid, liquid and gas.", "9.3.2 Communicate about the various uses of expansion and contraction of matter in daily life."], "9.4 Relation between the types of surfaces of objects to heat absorption and emission": ["9.4.1 Demonstrate how dark, dull objects absorb heat better than white, shiny objects.", "9.4.2 Demonstrate how dark, dull objects radiate heat better than white, shiny objects.", "9.4.3 Conceptualise and design using the heat concept in daily life."] },
            "10.0 SOUND WAVES": { "10.1 Characteristics of sound waves": ["10.1.1 communicate about the basic characteristics of sound waves."], "10.2 Loudness and pitch of sound": ["10.2.1 Explain frequency and its unit, and amplitude of vibration.", "10.2.2 Relate frequency to pitch.", "10.2.3. Relate amplitude to loudness.", "10.2.4 Explain with examples loudness and pitch using musical instruments."], "10.3 Phenomena and aplications of reflection of sound waves": ["10.3.1 Explain with example phenomena related to reflection of sound waves such as echo and Doppler effect", "10.3.2 Explain with example the applications of reflection of sound waves", "10.3.3 Elaborate and communicate about limitations of hearing for humans and animals", "10.3.4 Explain with examples ways to overcome human limitations of hearing"] },
            "11.0 STARS AND GALAXIES IN THE UNIVERSE": { "11.1 Stars and galaxies in the universe": ["11.1.1 Communicate about the characteristics of objects in space.", "11.1.2 Compare and contrast the characteristics of stars (including the Sun) and relate them to the obsevation of stars on the Earth."] },
            "12.0 SOLAR SYSTEM": { "12.1 Solar System": ["12.1.1 Compare distances between the Sun and the planets in the Solar System using astronomical units (a.u.) and light years.", "12.1.2 Construct a table to compare and contrast the planets in the Solar System with the Earth.", "12.1.3 Explore the possible relationship based on the planetsâ€™ characteristics.", "12.1.4 Reason and make analogies in hypothetical situations related to the Solar System.", "12.1.5 Justify the Earth as the most ideal planet for life based on data collected."] },
            "13.0 METEOROID, ASTEROID, COMET": { "13.1 Other objects in the Solar System": ["13.1.1 Communicate on other objects in the solar system, such as meteoroids, asteroids dan comets.", "13.1.2 Discuss the movements of meteoroids, asteroids and comets and their effects on the Earth based on data.", "13.1.3 Generate ideas on how to reduce or prevent the possibility of asteroids colliding with the Earth."] }
        };

        // --- INITIALIZATION ---
        window.onload = function() {
            const babSelect = document.getElementById("sel_bab");
            for (let bab in dskpData) {
                let opt = document.createElement("option"); opt.value = bab; opt.text = bab; babSelect.add(opt);
            }
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) document.getElementById('apiKey').value = savedKey;
        };

        function saveKey() {
            const key = document.getElementById('apiKey').value.trim();
            if(key) { localStorage.setItem('gemini_api_key', key); alert("Kunci API berjaya disimpan!"); }
        }

        // --- DROPDOWN LOGIC ---
        function updateSK() {
            const bab = document.getElementById("sel_bab").value; const skSelect = document.getElementById("sel_sk"); const spSelect = document.getElementById("sel_sp");
            skSelect.innerHTML = '<option value="">-- Pilih Standard Kandungan --</option>'; spSelect.innerHTML = '<option value="">-- Pilih Bab Dahulu --</option>';
            document.getElementById("txt_sk").value = ""; document.getElementById("txt_sp").value = "";
            spSelect.disabled = true; skSelect.disabled = !bab;
            
            if (bab) {
                for (let sk in dskpData[bab]) { let opt = document.createElement("option"); opt.value = sk; opt.text = sk; skSelect.add(opt); }
            }
        }

        function updateSP() {
            const bab = document.getElementById("sel_bab").value; const sk = document.getElementById("sel_sk").value; const spSelect = document.getElementById("sel_sp");
            spSelect.innerHTML = '<option value="">-- Pilih SP (Boleh Tambah Banyak) --</option>';
            document.getElementById("txt_sp").value = ""; document.getElementById("txt_sk").value = sk;
            spSelect.disabled = !sk;

            if (bab && sk) {
                dskpData[bab][sk].forEach(sp => {
                    let opt = document.createElement("option"); opt.value = sp; opt.text = sp.length > 80 ? sp.substring(0, 80) + "..." : sp; opt.setAttribute('data-full', sp); spSelect.add(opt);
                });
            }
        }

        function addSP() {
            const spSelect = document.getElementById("sel_sp"); const txtSp = document.getElementById("txt_sp"); const selected = spSelect.options[spSelect.selectedIndex];
            if (selected.value) {
                const fullText = selected.getAttribute('data-full');
                if (txtSp.value.trim() === "") txtSp.value = fullText;
                else if (!txtSp.value.includes(fullText)) txtSp.value += "\n" + fullText;
                spSelect.selectedIndex = 0;
            }
        }

        // --- AI LOGIC (FETCH METHOD - PALING STABIL UNTUK GITHUB/LOCAL) ---
        async function runAI(mode) {
            const key = document.getElementById('apiKey').value.trim();
            if(!key) return alert("Sila masukkan API Key dahulu!");
            
            // Show Loading
            const loader = document.getElementById('loading-overlay');
            const loadText = document.getElementById('loading-text');
            loader.classList.add('active');
            loadText.innerText = "Gemini sedang menjana idea...";

            // Prepare Data
            const sk = document.getElementById('txt_sk').value;
            const sp = document.getElementById('txt_sp').value;
            
            // Prompt Logic
            let prompt = "";
            if (mode === 'obj') {
                prompt = `Anda adalah Cikgu Sains Tingkatan 2. Bina 2-3 Objektif Pembelajaran (SMART) yang ringkas dalam Bahasa Melayu berdasarkan: Standard Kandungan: ${sk}, Standard Pembelajaran: ${sp}. Berikan dalam format bullet point (-). Jangan bagi intro/outro.`;
            } else {
                const obj = document.getElementById('txt_obj').value;
                prompt = `Bina aktiviti RPH Sains Tingkatan 2 menggunakan Model 5E (Engage, Explore, Explain, Elaborate, Evaluate) dalam Bahasa Melayu. Topik: ${sk}, SP: ${sp}, Objektif: ${obj}. Berikan isi penting sahaja, ringkas dan padat. Format: 1. Engage: [Aktiviti]...`;
            }

            // Call API
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                } else if (data.candidates && data.candidates[0].content) {
                    const resultText = data.candidates[0].content.parts[0].text;
                    document.getElementById(mode === 'obj' ? 'txt_obj' : 'txt_akt').value = resultText;
                } else {
                    throw new Error("Tiada respon dari AI.");
                }
            } catch (e) {
                alert("Ralat AI: " + e.message + "\n\nTip: Pastikan API Key betul dan tiada sekatan.");
            } finally {
                loader.classList.remove('active');
            }
        }

        // --- PDF LOGIC (VIEW SWITCHING) ---
        function prepareAndPrint() {
            window.scrollTo(0,0);
            
            // Transfer Data
            const map = {
                'inp_subject': 'out_subject', 'inp_kelas': 'out_kelas', 'inp_masa': 'out_masa',
                'sel_bab': 'out_bab', 'txt_sk': 'out_sk', 'txt_sp': 'out_sp',
                'txt_obj': 'out_obj', 'txt_akt': 'out_akt', 'txt_pbd': 'out_pbd'
            };
            for (let id in map) {
                document.getElementById(map[id]).innerText = document.getElementById(id).value || '-';
            }
            
            // Date Format
            const rawD = document.getElementById('inp_tarikh').value;
            document.getElementById('out_tarikh').innerText = rawD ? new Date(rawD).toLocaleDateString('ms-MY', {day:'2-digit', month:'2-digit', year:'numeric'}) : '-';

            // Switch View
            document.body.classList.add('generating-mode');
            const btn = document.getElementById('btnGenerate');
            const oriText = btn.innerText;
            btn.innerText = "Menjana...";
            btn.disabled = true;

            setTimeout(() => {
                const element = document.getElementById('pdf-preview-section');
                const fname = `RPH_Sains_${document.getElementById('inp_kelas').value || 'T2'}.pdf`;
                
                html2pdf().set({
                    margin: 0, filename: fname,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).from(element).save().then(() => {
                    document.body.classList.remove('generating-mode');
                    btn.innerText = oriText; btn.disabled = false;
                }).catch(err => {
                    alert("Ralat PDF.");
                    document.body.classList.remove('generating-mode');
                    btn.innerText = oriText; btn.disabled = false;
                });
            }, 800);
        }
    </script>
</body>
</html>
